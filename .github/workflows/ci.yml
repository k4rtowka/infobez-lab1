name: CI/CD Security Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: write

jobs:
  security-check:
    name: Security Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Run Snyk test (SAST)
        continue-on-error: true
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --json-file-output=snyk-sast-report.json
        id: snyk-sast
        if: env.SNYK_TOKEN != ''

      - name: Run Snyk test for SCA
        continue-on-error: true
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=low --json-file-output=snyk-sca-report.json
        id: snyk-sca
        if: env.SNYK_TOKEN != ''

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: |
            snyk-sast-report.json
            snyk-sca-report.json
          if-no-files-found: ignore
          retention-days: 30

  publish-reports:
    name: Publish Reports
    runs-on: ubuntu-latest
    needs: security-check
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download security reports
        uses: actions/download-artifact@v4
        with:
          name: security-reports
          path: reports/

      - name: Generate HTML reports
        run: |
          mkdir -p reports/html
          python3 -c "
          import json
          import os

          def generate_html_report(json_file, html_file, title):
              try:
                  with open(json_file, 'r') as f:
                      data = json.load(f)
                  
                  vulnerabilities = data.get('vulnerabilities', [])
                  
                  critical_count = sum(1 for v in vulnerabilities if v.get('severity') == 'critical')
                  high_count = sum(1 for v in vulnerabilities if v.get('severity') == 'high')
                  medium_count = sum(1 for v in vulnerabilities if v.get('severity') == 'medium')
                  low_count = sum(1 for v in vulnerabilities if v.get('severity') == 'low')
                  
                  html = f'''<!DOCTYPE html>
          <html>
          <head>
              <meta charset=\"UTF-8\">
              <title>{title}</title>
              <style>
                  body {{ font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }}
                  .container {{ max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }}
                  h1 {{ color: #333; border-bottom: 3px solid #4CAF50; padding-bottom: 10px; }}
                  .summary {{ background: #f9f9f9; padding: 15px; border-radius: 5px; margin: 20px 0; }}
                  .vuln {{ background: #fff; border-left: 4px solid #ff9800; padding: 15px; margin: 10px 0; border-radius: 4px; }}
                  .critical {{ border-left-color: #f44336; }}
                  .high {{ border-left-color: #ff9800; }}
                  .medium {{ border-left-color: #ffc107; }}
                  .low {{ border-left-color: #4CAF50; }}
                  .severity {{ display: inline-block; padding: 5px 10px; border-radius: 3px; font-weight: bold; margin-right: 10px; }}
                  .severity.critical {{ background: #f44336; color: white; }}
                  .severity.high {{ background: #ff9800; color: white; }}
                  .severity.medium {{ background: #ffc107; color: black; }}
                  .severity.low {{ background: #4CAF50; color: white; }}
                  .no-vuln {{ text-align: center; padding: 40px; color: #4CAF50; font-size: 18px; }}
              </style>
          </head>
          <body>
              <div class=\"container\">
                  <h1>{title}</h1>
                  <div class=\"summary\">
                      <h2>Summary</h2>
                      <p><strong>Total vulnerabilities:</strong> {len(vulnerabilities)}</p>
                      <p><strong>Critical:</strong> {critical_count}</p>
                      <p><strong>High:</strong> {high_count}</p>
                      <p><strong>Medium:</strong> {medium_count}</p>
                      <p><strong>Low:</strong> {low_count}</p>
                  </div>'''
                  
                  if vulnerabilities:
                      html += '<h2>Vulnerabilities</h2>'
                      for vuln in vulnerabilities:
                          severity = vuln.get('severity', 'unknown').lower()
                          title_text = vuln.get('title', 'Unknown').replace('\"', '&quot;')
                          desc = vuln.get('description', 'No description')[:200].replace('\"', '&quot;')
                          pkg = vuln.get('packageName', 'N/A')
                          ver = vuln.get('version', 'N/A')
                          html += f'''
                  <div class=\"vuln {severity}\">
                      <span class=\"severity {severity}\">{severity.upper()}</span>
                      <strong>{title_text}</strong>
                      <p>{desc}...</p>
                      <p><small>Package: {pkg} | Version: {ver}</small></p>
                  </div>'''
                  else:
                      html += '<div class=\"no-vuln\">âœ… No vulnerabilities found</div>'
                  
                  html += '''
              </div>
          </body>
          </html>'''
                  
                  with open(html_file, 'w') as f:
                      f.write(html)
                  print(f'Generated {html_file}')
              except Exception as e:
                  print(f'Error generating report: {e}')

          if os.path.exists('reports/snyk-sast-report.json'):
              generate_html_report('reports/snyk-sast-report.json', 'reports/html/sast-report.html', 'SAST Security Report')

          if os.path.exists('reports/snyk-sca-report.json'):
              generate_html_report('reports/snyk-sca-report.json', 'reports/html/sca-report.html', 'SCA Dependency Vulnerability Report')

          if not os.path.exists('reports/html/sast-report.html'):
              with open('reports/html/sast-report.html', 'w') as f:
                  f.write('<!DOCTYPE html><html><head><title>SAST Report</title></head><body><h1>SAST Report</h1><p>No report generated</p></body></html>')

          if not os.path.exists('reports/html/sca-report.html'):
              with open('reports/html/sca-report.html', 'w') as f:
                  f.write('<!DOCTYPE html><html><head><title>SCA Report</title></head><body><h1>SCA Report</h1><p>No report generated</p></body></html>')
          "

      - name: Create summary page
        run: |
          python3 -c "
          html = '''<!DOCTYPE html>
          <html>
          <head>
              <meta charset=\"UTF-8\">
              <title>Security Reports Summary</title>
              <style>
                  body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }
                  .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
                  h1 { color: #333; border-bottom: 3px solid #4CAF50; padding-bottom: 10px; }
                  .report-link { display: block; padding: 15px; margin: 10px 0; background: #f9f9f9; border-radius: 5px; text-decoration: none; color: #333; border-left: 4px solid #4CAF50; }
                  .report-link:hover { background: #e8f5e9; }
                  .report-link h2 { margin: 0 0 5px 0; color: #4CAF50; }
              </style>
          </head>
          <body>
              <div class=\"container\">
                  <h1>Security Reports Summary</h1>
                  <a href=\"sast-report.html\" class=\"report-link\">
                      <h2>SAST Report</h2>
                      <p>Static Application Security Testing Report</p>
                  </a>
                  <a href=\"sca-report.html\" class=\"report-link\">
                      <h2>SCA Report</h2>
                      <p>Software Composition Analysis Report</p>
                  </a>
              </div>
          </body>
          </html>'''
          with open('reports/html/index.html', 'w') as f:
              f.write(html)
          "

      - name: Prepare reports for GitHub Pages
        if: always()
        run: |
          mkdir -p reports-pages
          mkdir -p reports-pages/run-${{ github.run_id }}
          if [ -f reports/html/sast-report.html ]; then
            cp reports/html/sast-report.html reports-pages/run-${{ github.run_id }}/sast-report.html
          fi
          if [ -f reports/html/sca-report.html ]; then
            cp reports/html/sca-report.html reports-pages/run-${{ github.run_id }}/sca-report.html
          fi
          if [ -f reports/html/index.html ]; then
            cp reports/html/index.html reports-pages/run-${{ github.run_id }}/index.html
          fi

          python3 -c "
          html = '''<!DOCTYPE html>
          <html>
          <head>
              <meta charset=\"UTF-8\">
              <title>Security Reports</title>
              <style>
                  body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }
                  .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
                  h1 { color: #333; }
                  .run-link { display: block; padding: 15px; margin: 10px 0; background: #f9f9f9; border-radius: 5px; text-decoration: none; color: #333; }
              </style>
          </head>
          <body>
              <div class=\"container\">
                  <h1>Security Reports</h1>
                  <p>Select a run to view reports:</p>
              </div>
          </body>
          </html>'''
          with open('reports-pages/index.html', 'w') as f:
              f.write(html)
          "

      - name: Deploy to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./reports-pages
          keep_files: true

      - name: Upload HTML reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports-html
          path: reports/html/
          retention-days: 30

      - name: Publish reports summary
        if: always()
        run: |
          REPO_OWNER="${{ github.repository_owner }}"
          REPO_NAME="${{ github.event.repository.name }}"
          RUN_ID="${{ github.run_id }}"
          PAGES_URL="https://${REPO_OWNER}.github.io/${REPO_NAME}/run-${RUN_ID}"

          echo "## Security Reports" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Available Reports:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f reports/html/sast-report.html ]; then
            echo "- [SAST Report](${PAGES_URL}/sast-report.html)" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f reports/html/sca-report.html ]; then
            echo "- [SCA Report](${PAGES_URL}/sca-report.html)" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
