name: CI/CD Security Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: write

jobs:
  security-check:
    name: Security Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Run Snyk code test (SAST)
        continue-on-error: true
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: code test
          args: --severity-threshold=high --json-file-output=snyk-sast-report.json
        id: snyk-sast
        if: env.SNYK_TOKEN != ''

      - name: Run Snyk test for SCA
        continue-on-error: true
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: test
          args: --severity-threshold=low --json-file-output=snyk-sca-report.json
        id: snyk-sca
        if: env.SNYK_TOKEN != ''

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: |
            snyk-sast-report.json
            snyk-sca-report.json
          if-no-files-found: ignore
          retention-days: 30

  publish-reports:
    name: Publish Reports
    runs-on: ubuntu-latest
    needs: security-check
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download security reports
        uses: actions/download-artifact@v4
        with:
          name: security-reports
          path: reports/

      - name: Install snyk-to-html
        if: always()
        run: npm install -g snyk-to-html

      - name: Generate HTML reports
        if: always()
        run: |
          mkdir -p reports/html

          if [ -f reports/snyk-sast-report.json ]; then
            python3 -c "import json; d=json.load(open('reports/snyk-sast-report.json')); c=len(d.get('vulnerabilities',[])) if 'vulnerabilities' in d else 0; s='No vulnerabilities found' if c==0 else f'Found {c} issue(s)'; h=f'<!DOCTYPE html><html><head><meta charset=\"UTF-8\"><title>SAST Report</title><style>body{{font-family:Arial;margin:20px;background:#f5f5f5}}.c{{max-width:1200px;margin:0 auto;background:white;padding:20px;border-radius:8px}}h1{{color:#333;border-bottom:3px solid #4CAF50;padding-bottom:10px}}.n{{text-align:center;padding:40px;color:#4CAF50;font-size:18px}}</style></head><body><div class=\"c\"><h1>SAST Report</h1><div class=\"n\">{s}</div></div></body></html>'; open('reports/html/sast-report.html','w').write(h)"
          else
            echo '<!DOCTYPE html><html><head><title>SAST Report</title><style>body{font-family:Arial;margin:20px;background:#f5f5f5}.c{max-width:1200px;margin:0 auto;background:white;padding:20px;border-radius:8px}h1{color:#333;border-bottom:3px solid #4CAF50;padding-bottom:10px}.n{text-align:center;padding:40px;color:#4CAF50;font-size:18px}</style></head><body><div class="c"><h1>SAST Report</h1><div class="n">✓ No security issues found</div></div></body></html>' > reports/html/sast-report.html
          fi

          if [ -f reports/snyk-sca-report.json ] && [ -s reports/snyk-sca-report.json ]; then
            snyk-to-html -i reports/snyk-sca-report.json -o reports/html/sca-report.html || echo '<!DOCTYPE html><html><head><title>SCA Report</title></head><body><h1>SCA Report</h1><p>Report generation failed</p></body></html>' > reports/html/sca-report.html
          else
            echo '<!DOCTYPE html><html><head><title>SCA Report</title><style>body{font-family:Arial;margin:20px;background:#f5f5f5}.c{max-width:1200px;margin:0 auto;background:white;padding:20px;border-radius:8px}h1{color:#333;border-bottom:3px solid #4CAF50;padding-bottom:10px}.n{text-align:center;padding:40px;color:#4CAF50;font-size:18px}</style></head><body><div class="c"><h1>SCA Report</h1><div class="n">✓ No vulnerabilities found in dependencies</div></div></body></html>' > reports/html/sca-report.html
          fi

      - name: Create summary page
        if: always()
        run: |
          python3 -c "
          html = '''<!DOCTYPE html>
          <html>
          <head>
              <meta charset=\"UTF-8\">
              <title>Security Reports</title>
              <style>
                  body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }
                  .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
                  h1 { color: #333; border-bottom: 3px solid #4CAF50; padding-bottom: 10px; }
                  .report-link { display: block; padding: 15px; margin: 10px 0; background: #f9f9f9; border-radius: 5px; text-decoration: none; color: #333; border-left: 4px solid #4CAF50; }
                  .report-link:hover { background: #e8f5e9; }
                  .report-link h2 { margin: 0 0 5px 0; color: #4CAF50; }
              </style>
          </head>
          <body>
              <div class=\"container\">
                  <h1>Security Reports</h1>
                  <a href=\"sast-report.html\" class=\"report-link\">
                      <h2>SAST Report</h2>
                      <p>Static Application Security Testing Report</p>
                  </a>
                  <a href=\"sca-report.html\" class=\"report-link\">
                      <h2>SCA Report</h2>
                      <p>Software Composition Analysis Report</p>
                  </a>
              </div>
          </body>
          </html>'''
          with open('reports/html/index.html', 'w') as f:
              f.write(html)
          "

      - name: Prepare reports for GitHub Pages
        if: always()
        run: |
          mkdir -p reports-pages/run-${{ github.run_id }}
          cp reports/html/*.html reports-pages/run-${{ github.run_id }}/ 2>/dev/null || true

      - name: Deploy to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./reports-pages
          keep_files: true

      - name: Upload HTML reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports-html
          path: reports/html/
          retention-days: 30

      - name: Publish reports summary
        if: always()
        run: |
          REPO_OWNER="${{ github.repository_owner }}"
          REPO_NAME="${{ github.event.repository.name }}"
          RUN_ID="${{ github.run_id }}"
          PAGES_URL="https://${REPO_OWNER}.github.io/${REPO_NAME}/run-${RUN_ID}"

          echo "## Security Reports" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Available Reports:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f reports/html/sast-report.html ]; then
            echo "- [SAST Report](${PAGES_URL}/sast-report.html)" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f reports/html/sca-report.html ]; then
            echo "- [SCA Report](${PAGES_URL}/sca-report.html)" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
