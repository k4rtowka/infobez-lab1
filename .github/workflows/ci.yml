name: CI/CD Security Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: write

jobs:
  security-check:
    name: Security Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Run Snyk code test (SAST)
        continue-on-error: true
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: code test
          args: --severity-threshold=high --json-file-output=snyk-sast-report.json
        id: snyk-sast
        if: env.SNYK_TOKEN != ''

      - name: Run Snyk test for SCA
        continue-on-error: true
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: test
          args: --severity-threshold=low --json-file-output=snyk-sca-report.json
        id: snyk-sca
        if: env.SNYK_TOKEN != ''

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: |
            snyk-sast-report.json
            snyk-sca-report.json
          if-no-files-found: ignore
          retention-days: 30

  publish-reports:
    name: Publish Reports
    runs-on: ubuntu-latest
    needs: security-check
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download security reports
        uses: actions/download-artifact@v4
        with:
          name: security-reports
          path: reports/

      - name: Generate HTML reports
        if: always()
        run: |
          mkdir -p reports/html
          
          python3 << 'PYEOF'
import json
import os
from datetime import datetime

def generate_sast_report(json_file, html_file):
    issues = []
    if os.path.exists(json_file) and os.path.getsize(json_file) > 0:
        try:
            with open(json_file, 'r') as f:
                data = json.load(f)
            
            if 'runs' in data:
                for run in data.get('runs', []):
                    for result in run.get('results', []):
                        rule_id = result.get('ruleId', 'unknown')
                        level = result.get('level', 'unknown')
                        message = result.get('message', {}).get('text', 'No message')
                        for location in result.get('locations', []):
                            file_path = location.get('physicalLocation', {}).get('artifactLocation', {}).get('uri', 'unknown')
                            issues.append({
                                'severity': level,
                                'rule': rule_id,
                                'message': message,
                                'file': file_path
                            })
        except Exception as e:
            pass
    
    html = f'''<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>SAST Report - Static Application Security Testing</title>
    <style>
        body {{ font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f5f5f5; }}
        .container {{ max-width: 1400px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }}
        h1 {{ color: #333; border-bottom: 3px solid #4CAF50; padding-bottom: 15px; margin-bottom: 20px; }}
        .summary {{ background: #f9f9f9; padding: 20px; border-radius: 5px; margin-bottom: 30px; }}
        .summary-item {{ display: inline-block; margin-right: 30px; }}
        .summary-item strong {{ color: #333; font-size: 24px; display: block; }}
        .summary-item span {{ color: #666; }}
        table {{ width: 100%; border-collapse: collapse; margin-top: 20px; }}
        th {{ background: #4CAF50; color: white; padding: 12px; text-align: left; }}
        td {{ padding: 12px; border-bottom: 1px solid #ddd; }}
        tr:hover {{ background: #f5f5f5; }}
        .severity-high {{ color: #f44336; font-weight: bold; }}
        .severity-medium {{ color: #ff9800; font-weight: bold; }}
        .severity-low {{ color: #4CAF50; }}
        .severity-info {{ color: #2196F3; }}
        .no-issues {{ text-align: center; padding: 40px; color: #4CAF50; font-size: 18px; }}
        .file-path {{ font-family: monospace; color: #666; font-size: 12px; }}
    </style>
</head>
<body>
    <div class="container">
        <h1>SAST Report - Static Application Security Testing</h1>
        <div class="summary">
            <div class="summary-item">
                <strong>{len(issues)}</strong>
                <span>Total Issues</span>
            </div>
            <div class="summary-item">
                <strong>{len([i for i in issues if i['severity'] == 'error'])}</strong>
                <span>High Severity</span>
            </div>
            <div class="summary-item">
                <strong>{len([i for i in issues if i['severity'] == 'warning'])}</strong>
                <span>Medium Severity</span>
            </div>
            <div class="summary-item">
                <strong>{len([i for i in issues if i['severity'] == 'note'])}</strong>
                <span>Low Severity</span>
            </div>
        </div>
'''
    
    if issues:
        html += '''
        <table>
            <thead>
                <tr>
                    <th>Severity</th>
                    <th>Rule ID</th>
                    <th>Message</th>
                    <th>File</th>
                </tr>
            </thead>
            <tbody>
'''
        for issue in issues:
            severity_class = f"severity-{issue['severity']}" if issue['severity'] in ['high', 'medium', 'low', 'info'] else "severity-info"
            severity_display = issue['severity'].upper() if issue['severity'] != 'error' else 'HIGH'
            html += f'''
                <tr>
                    <td class="{severity_class}">{severity_display}</td>
                    <td>{issue['rule']}</td>
                    <td>{issue['message']}</td>
                    <td class="file-path">{issue['file']}</td>
                </tr>
'''
        html += '''
            </tbody>
        </table>
'''
    else:
        html += '<div class="no-issues">✓ No security issues found</div>'
    
    html += f'''
        <p style="margin-top: 30px; color: #666; font-size: 12px;">Generated: {datetime.now().strftime("%Y-%m-%d %H:%M:%S")}</p>
    </div>
</body>
</html>'''
    
    with open(html_file, 'w') as f:
        f.write(html)

def generate_sca_report(json_file, html_file):
    vulnerabilities = []
    if os.path.exists(json_file) and os.path.getsize(json_file) > 0:
        try:
            with open(json_file, 'r') as f:
                data = json.load(f)
            
            if 'vulnerabilities' in data:
                vulnerabilities = data['vulnerabilities']
        except Exception as e:
            pass
    
    html = f'''<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>SCA Report - Software Composition Analysis</title>
    <style>
        body {{ font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f5f5f5; }}
        .container {{ max-width: 1400px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }}
        h1 {{ color: #333; border-bottom: 3px solid #4CAF50; padding-bottom: 15px; margin-bottom: 20px; }}
        .summary {{ background: #f9f9f9; padding: 20px; border-radius: 5px; margin-bottom: 30px; }}
        .summary-item {{ display: inline-block; margin-right: 30px; }}
        .summary-item strong {{ color: #333; font-size: 24px; display: block; }}
        .summary-item span {{ color: #666; }}
        table {{ width: 100%; border-collapse: collapse; margin-top: 20px; }}
        th {{ background: #4CAF50; color: white; padding: 12px; text-align: left; }}
        td {{ padding: 12px; border-bottom: 1px solid #ddd; }}
        tr:hover {{ background: #f5f5f5; }}
        .severity-high {{ color: #f44336; font-weight: bold; }}
        .severity-medium {{ color: #ff9800; font-weight: bold; }}
        .severity-low {{ color: #4CAF50; }}
        .no-issues {{ text-align: center; padding: 40px; color: #4CAF50; font-size: 18px; }}
        .package {{ font-family: monospace; }}
    </style>
</head>
<body>
    <div class="container">
        <h1>SCA Report - Software Composition Analysis</h1>
        <div class="summary">
            <div class="summary-item">
                <strong>{len(vulnerabilities)}</strong>
                <span>Total Vulnerabilities</span>
            </div>
            <div class="summary-item">
                <strong>{len([v for v in vulnerabilities if v.get('severity') == 'high'])}</strong>
                <span>High Severity</span>
            </div>
            <div class="summary-item">
                <strong>{len([v for v in vulnerabilities if v.get('severity') == 'medium'])}</strong>
                <span>Medium Severity</span>
            </div>
            <div class="summary-item">
                <strong>{len([v for v in vulnerabilities if v.get('severity') == 'low'])}</strong>
                <span>Low Severity</span>
            </div>
        </div>
'''
    
    if vulnerabilities:
        html += '''
        <table>
            <thead>
                <tr>
                    <th>Severity</th>
                    <th>Package</th>
                    <th>Vulnerability</th>
                    <th>Title</th>
                </tr>
            </thead>
            <tbody>
'''
        for vuln in vulnerabilities:
            severity = vuln.get('severity', 'unknown').lower()
            severity_class = f"severity-{severity}"
            package = vuln.get('packageName', 'unknown')
            title = vuln.get('title', 'No title')
            id_val = vuln.get('id', 'N/A')
            html += f'''
                <tr>
                    <td class="{severity_class}">{severity.upper()}</td>
                    <td class="package">{package}</td>
                    <td>{id_val}</td>
                    <td>{title}</td>
                </tr>
'''
        html += '''
            </tbody>
        </table>
'''
    else:
        html += '<div class="no-issues">✓ No vulnerabilities found in dependencies</div>'
    
    html += f'''
        <p style="margin-top: 30px; color: #666; font-size: 12px;">Generated: {datetime.now().strftime("%Y-%m-%d %H:%M:%S")}</p>
    </div>
</body>
</html>'''
    
    with open(html_file, 'w') as f:
        f.write(html)

generate_sast_report('reports/snyk-sast-report.json', 'reports/html/sast-report.html')
generate_sca_report('reports/snyk-sca-report.json', 'reports/html/sca-report.html')
PYEOF

      - name: Create summary page
        if: always()
        run: |
          python3 -c "
          html = '''<!DOCTYPE html>
          <html>
          <head>
              <meta charset=\"UTF-8\">
              <title>Security Reports</title>
              <style>
                  body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }
                  .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
                  h1 { color: #333; border-bottom: 3px solid #4CAF50; padding-bottom: 10px; }
                  .report-link { display: block; padding: 15px; margin: 10px 0; background: #f9f9f9; border-radius: 5px; text-decoration: none; color: #333; border-left: 4px solid #4CAF50; }
                  .report-link:hover { background: #e8f5e9; }
                  .report-link h2 { margin: 0 0 5px 0; color: #4CAF50; }
              </style>
          </head>
          <body>
              <div class=\"container\">
                  <h1>Security Reports</h1>
                  <a href=\"sast-report.html\" class=\"report-link\">
                      <h2>SAST Report</h2>
                      <p>Static Application Security Testing Report</p>
                  </a>
                  <a href=\"sca-report.html\" class=\"report-link\">
                      <h2>SCA Report</h2>
                      <p>Software Composition Analysis Report</p>
                  </a>
              </div>
          </body>
          </html>'''
          with open('reports/html/index.html', 'w') as f:
              f.write(html)
          "

      - name: Prepare reports for GitHub Pages
        if: always()
        run: |
          mkdir -p reports-pages/run-${{ github.run_id }}
          cp reports/html/*.html reports-pages/run-${{ github.run_id }}/ 2>/dev/null || true

      - name: Deploy to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./reports-pages
          keep_files: true

      - name: Upload HTML reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports-html
          path: reports/html/
          retention-days: 30

      - name: Publish reports summary
        if: always()
        run: |
          REPO_OWNER="${{ github.repository_owner }}"
          REPO_NAME="${{ github.event.repository.name }}"
          RUN_ID="${{ github.run_id }}"
          PAGES_URL="https://${REPO_OWNER}.github.io/${REPO_NAME}/run-${RUN_ID}"

          echo "## Security Reports" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Available Reports:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f reports/html/sast-report.html ]; then
            echo "- [SAST Report](${PAGES_URL}/sast-report.html)" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f reports/html/sca-report.html ]; then
            echo "- [SCA Report](${PAGES_URL}/sca-report.html)" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
